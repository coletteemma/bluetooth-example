<html>

<head>
    <script>
        var connected = false;
        var services_discovered = false;
        var selected_device;
        var connected_server;

        function setConnectedStatus(status) {
            connected = status;
            document.getElementById('status_connected').innerHTML = status;
            if (status == true) {
                document.getElementById('btn_scan').innerHTML = "Disconnect";
            } else {
                document.getElementById('btn_scan').innerHTML = "Discover Devices";
            }
        }

        function setDiscoveryStatus(status) {
            services_discovered = status;
            document.getElementById('status_discovered').innerHTML = status;
        }


        function discoverDevicesOrDisconnect() {
            if (!connected) {
                discoverDevices();
            } else {
                console.log("already connected");
            }
            console.log("discoverDevicesOrDisconnect");
        }

        function discoverDevices() {
            console.log("discoverDevices");
            var options = {
                acceptAllDevices: true
            }
            navigator.bluetooth.requestDevice(options)
                .then(device => {
                    console.log('> Name: ' + device.name);
                    console.log('> Id:' + device.id);
                    console.log('> Connected:' + device.gatt.connected);
                    selected_device = device;
                    console.log(selected_device);
                    alert("Found device " + device.name + " with connected status " + device.gatt.connected);
                    connect();
                    alert("Found device " + device.name + " with connected status " + device.gatt.connected);
                })
                .catch(error => {
                    alert('ERROR: ' + error);
                    console.log('ERROR: ' + error);

                });

        }
        function connect() {
            if (connected == false) {
                console.log("connecting");
                selected_device.gatt.connect().then(
                    function (server) {
                        console.log("Connected to " + server.device.id);
                        console.log("connected=" + server.connected);
                        setConnectedStatus(true);
                        connected_server = server;
                        selected_device.addEventListener('gattserverdisconnected', onDisconnected);
                    },
                    function (error) {
                        console.log("ERROR: could not connect - " + error);
                        alert("ERROR: could not connect - " + error);
                        setConnectedStatus(false);
                    });
                function onDisconnected() {
                    console.log("onDisconnected");
                    resetUI();
                }
                function resetUI() {
                    setConnectedStatus(false);
                    setDiscoveryStatus(false);
                    document.getElementById('model_number').innerHTML = "";
                    document.getElementById('accelerometer_data').innerHTML = "";
                }
            }
        

        function readModelNumber() {
            console.log("readModelNumber");
        }

        function randomLEDs() {
            console.log("randomLEDs");
        }

        function toggleAccelerometerNotifications() {
            console.log("toggleAccelerometerNotifications");
        }

    </script>
</head>

<body>

    <body>
        <h1>Web Bluetooth - first attempt</h1>
        <h2>Status</h2>
        <table border="1">
            <tr>
                <td>
                    <b>Connected</b>
                </td>
                <td>
                    <b>Service Discovery Completed</b>
                </td>
                <td>
                    <b>Notifications</b>
                </td>
            </tr>
            <tr>
            </tr>
        </table>
        <td id="status_connected">false</td>
        <td id="status_discovered">false</td>
        <td id="status_notifications">false</td>
        <h2>Device Discovery and Connection</h2>
        <button id="btn_scan" onclick=" discoverDevicesOrDisconnect()">Discover Devices
        </button>
        <hr>
        <h2>Reading and Writing</h2>
        <h3>Read Characteristic - Model Number</h3>
        <button id="btn_read" onclick="readModelNumber()">Read Model Number
        </button>
        <div id="model_number"></div>
        <h3>Write Characteristic - Randomise Lights</h3>
        <button id="btn_write" onclick="randomLEDs()">Randomise LEDs</button>
        <hr>
        <h2>Notifications - Accelerometer X, Y, Z</h2>
        <button id="btn_notify" onclick="toggleAccelerometerNotifications()">Toggle Notifications</button>
        <div id="accelerometer_data"></div>
        <a href="https://twitter.com/intent/tweet?screen_name=TwitterDev&ref_src=twsrc%5Etfw" class="twitter-mention-button" data-show-count="false">Tweet to @TwitterDev</a>
        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </body>

</html>